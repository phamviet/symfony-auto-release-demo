name: CI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  auto:
    name: Auto
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'ci skip') && !contains(github.event.head_commit.message, 'skip ci')"
    continue-on-error: false
    strategy:
      matrix:
        php-versions: ["8.1"]
    env:
      RUNTIME_OS: linux
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Prepare repository
      run: git fetch --unshallow --tags

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-versions }}
        coverage: "none"

    - uses: actions/setup-node@v3
      with:
        node-version: 16

    - name: "Manual release"
      if: ${{ github.event_name == 'workflow_dispatch' && github.ref_name == 'main' }}
      run: |
        yarn global add auto-plugin-composer
        ./bin/auto latest --verbose

    - name: "Release"
      if:  ${{ github.event_name == 'push' }}
      run: |
        yarn global add auto-plugin-composer
        ./bin/auto latest --verbose --only-publish-with-release-label

#    - name: Create Pull Request
#      id: cpr
#      uses: peter-evans/create-pull-request@v4
#      with:
#        title: AWS Release
#        branch: production
#        base: main

#    - name: Automerge Pull Request
#      if: steps.cpr.outputs.pull-request-operation == 'created'
#      uses: peter-evans/enable-pull-request-automerge@v2
#      with:
#        token: ${{ secrets.GITHUB_TOKEN }}
#        pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
